<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Geo-Master Europa 7.0 - Komplettversion</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary: #2c3e50; --accent: #3498db; --success: #27ae60;
            --danger: #e74c3c; --light: #f8f9fa;
        }

        body, html { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; background: #aad3df; }

        /* --- SIDEBAR --- */
        #quiz-sidebar {
            position: absolute; top: 0; left: -350px; width: 320px; height: 100%;
            background: white; z-index: 2000; transition: 0.4s ease;
            box-shadow: 5px 0 25px rgba(0,0,0,0.3); padding: 20px;
            display: flex; flex-direction: column;
        }
        #quiz-sidebar.open { left: 0; }
        .close-sidebar { 
            position: absolute; top: 10px; right: 10px; background: none; 
            border: none; font-size: 20px; cursor: pointer; color: #999; 
        }

        #menu-toggle {
            position: absolute; bottom: 30px; left: 20px; z-index: 1500;
            background: var(--primary); color: white; border: none; padding: 15px 25px;
            border-radius: 50px; cursor: pointer; font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        /* --- SEARCH --- */
        #search-box {
            position: absolute; top: 20px; left: 20px; z-index: 1000; width: 250px;
        }
        #search-input {
            width: 100%; padding: 12px 20px; border-radius: 25px; border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); outline: none;
        }

        /* --- PROGRESS --- */
        .progress-container { margin: 15px 0; background: #eee; border-radius: 12px; height: 20px; overflow: hidden; position: relative; }
        #progress-bar { height: 100%; background: var(--success); width: 0%; transition: 0.5s; }
        #progress-text { position: absolute; width: 100%; text-align: center; font-size: 0.75rem; line-height: 20px; font-weight: bold; }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        .btn-start { background: var(--accent); color: white; }
        .btn-stop { background: var(--danger); color: white; display: none; }

        #feedback-overlay {
            position: absolute; top: 20%; left: 50%; transform: translate(-50%, -50%);
            z-index: 3000; padding: 20px 40px; border-radius: 50px; color: white;
            font-weight: bold; font-size: 2em; display: none; pointer-events: none;
        }
        
        .wiki-card img { width: 100%; border-radius: 5px; margin-top: 10px; }
    </style>
</head>
<body>

<div id="search-box">
    <input type="text" id="search-input" placeholder="ðŸ” Ort suchen..." oninput="doSearch(this.value)">
</div>

<button id="menu-toggle" onclick="toggleMenu()">â˜° Quiz & Fortschritt</button>

<div id="quiz-sidebar">
    <button class="close-sidebar" onclick="toggleMenu()">Ã—</button>
    <h2>ðŸŽ“ Lern-Zentrale</h2>
    
    <div class="progress-container">
        <div id="progress-bar"></div>
        <div id="progress-text">0% Meisterung</div>
    </div>

    <p>XP: <span id="stat-xp" style="font-weight:bold; color:var(--accent)">0</span></p>

    <div id="quiz-question" style="font-size: 1.2em; color: var(--danger); font-weight: bold; margin: 20px 0; min-height: 50px;">
        Klicke Start fÃ¼r das Quiz!
    </div>
    
    <label style="display:block; margin-bottom: 10px;">
        <input type="checkbox" id="no-duplicates"> ðŸš« Keine Dopplungen (einmal pro Runde)
    </label>
    <label style="display:block; margin-bottom: 20px;">
        <input type="checkbox" id="hard-mode"> ðŸ¤« Profi-Modus (Namen aus)
    </label>

    <button class="btn btn-start" id="btn-start" onclick="startQuiz()">Quiz starten</button>
    <button class="btn btn-stop" id="btn-stop" onclick="stopQuiz()">Beenden</button>
</div>

<div id="feedback-overlay"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- MAP INITIALISIERUNG ---
    var map = L.map('map', { zoomControl: false }).setView([50, 15], 4);
    
    // Panes fÃ¼r Klickbarkeit (StÃ¤dte Ã¼ber FlÃ¤chen)
    map.createPane('areaPane').style.zIndex = 400;
    map.createPane('topPane').style.zIndex = 650;

    var topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17 }).addTo(map);
    var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    // Layer Gruppen 
    var lgGebirge = L.layerGroup().addTo(map);
    var lgFluesse = L.layerGroup().addTo(map);
    var lgSeen = L.layerGroup().addTo(map);
    var lgInseln = L.layerGroup().addTo(map);
    var lgStaedte = L.layerGroup().addTo(map);

    L.control.layers({ "ðŸ”ï¸ Topografie": topo, "ðŸ›°ï¸ Satellit": satellite }, 
                     { "ðŸ”ï¸ Gebirge": lgGebirge, "ã€°ï¸ FlÃ¼sse": lgFluesse, "ðŸ’§ Seen": lgSeen, "ðŸï¸ Inseln": lgInseln, "ðŸ™ï¸ StÃ¤dte": lgStaedte },
                     { collapsed: false, position: 'topright' }).addTo(map);

    // --- LOGIK & SPEICHER ---
    let searchIndex = [];
    let sessionPool = []; // FÃ¼r "Keine Dopplungen"
    let masteredItems = JSON.parse(localStorage.getItem('geoMastered_v7') || '[]');
    let totalXP = parseInt(localStorage.getItem('geoTotalXP_v7') || '0');
    let quizActive = false;
    let currentTarget = null;

    function toggleMenu() { document.getElementById('quiz-sidebar').classList.toggle('open'); }

    // Wikipedia Funktion fÃ¼r ALLE Kategorien 
    async function fetchWiki(name, type) {
        let q = name;
        if(type === "Fluss") q += " (Fluss)";
        if(type === "Gebirge") q += " (Gebirge)";
        try {
            const res = await fetch(`https://de.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(q)}`);
            return res.ok ? await res.json() : null;
        } catch(e) { return null; }
    }

    // --- RENDER FUNKTIONEN ---
    function addPoly(group, coords, name, type, color) {
        let p = L.polygon(coords, { color: color, fillColor: color, fillOpacity: 0.3, weight: 1.5, pane: 'areaPane' }).addTo(group);
        p.bindTooltip(name, { sticky: true });
        p.on('click', (e) => handleInteraction(name, type, e, p));
        searchIndex.push({name, type, layer: p});
    }

    function addLine(group, coords, name) {
        let l = L.polyline(coords, { color: '#3498db', weight: 3, pane: 'topPane' }).addTo(group);
        l.bindTooltip(name, { sticky: true });
        l.on('click', (e) => handleInteraction(name, "Fluss", e, l));
        searchIndex.push({name, type: "Fluss", layer: l});
    }

    function addCity(coords, name) {
        let c = L.circleMarker(coords, { radius: 6, color: '#000', fillColor: '#fff', fillOpacity: 1, weight: 2, pane: 'topPane' }).addTo(lgStaedte);
        c.bindTooltip(name, { direction: 'top' });
        c.on('click', (e) => handleInteraction(name, "Stadt", e, c));
        searchIndex.push({name, type: "Stadt", layer: c});
    }

    // --- INTERAKTION ---
    async function handleInteraction(name, type, event, layer) {
        if (quizActive) {
            checkAnswer(name);
        } else {
            const data = await fetchWiki(name, type);
            let content = `<b>${name}</b> (${type})<br>`;
            if(data) {
                content += `<small>${data.extract}</small><br><img src="${data.thumbnail?.source || ''}">`;
            } else { content += "Keine Wikipedia-Details gefunden."; }
            L.popup().setLatLng(event.latlng || event.target.getLatLng()).setContent(content).openOn(map);
        }
    }

    // --- SUCHE ---
    function doSearch(val) {
        if(val.length < 2) return;
        const item = searchIndex.find(i => i.name.toLowerCase().includes(val.toLowerCase()));
        if(item) {
            map.flyTo(item.layer.getBounds ? item.layer.getBounds().getCenter() : item.layer.getLatLng(), 6);
            item.layer.openTooltip();
        }
    }

    // --- QUIZ ---
    function startQuiz() {
        quizActive = true;
        sessionPool = [...searchIndex]; // Pool fÃ¼llen
        document.getElementById('btn-start').style.display = 'none';
        document.getElementById('btn-stop').style.display = 'block';
        nextQuestion();
    }

    function stopQuiz() {
        quizActive = false;
        document.getElementById('btn-start').style.display = 'block';
        document.getElementById('btn-stop').style.display = 'none';
        document.getElementById('quiz-question').innerText = "Runde beendet!";
    }

    function nextQuestion() {
        if(!quizActive) return;
        if(document.getElementById('no-duplicates').checked && sessionPool.length === 0) {
            alert("Alle Orte dieser Runde geschafft!");
            stopQuiz(); return;
        }
        
        let pool = document.getElementById('no-duplicates').checked ? sessionPool : searchIndex;
        currentTarget = pool[Math.floor(Math.random() * pool.length)];
        document.getElementById('quiz-question').innerText = `Suche: ${currentTarget.name}`;
    }

    function checkAnswer(name) {
        const feedback = document.getElementById('feedback-overlay');
        feedback.style.display = 'block';
        if(name === currentTarget.name) {
            feedback.innerText = "âœ… Richtig! +10 XP";
            feedback.style.background = "var(--success)";
            totalXP += 10;
            if(document.getElementById('no-duplicates').checked) {
                sessionPool = sessionPool.filter(i => i.name !== name);
            }
            if(!masteredItems.includes(name)) masteredItems.push(name);
            localStorage.setItem('geoMastered_v7', JSON.stringify(masteredItems));
            localStorage.setItem('geoTotalXP_v7', totalXP);
            updateUI();
            setTimeout(() => { feedback.style.display = 'none'; nextQuestion(); }, 800);
        } else {
            feedback.innerText = "âŒ Falsch!";
            feedback.style.background = "var(--danger)";
            setTimeout(() => feedback.style.display = 'none', 800);
        }
    }

    function updateUI() {
        document.getElementById('stat-xp').innerText = totalXP;
        const percent = Math.round((masteredItems.length / searchIndex.length) * 100);
        document.getElementById('progress-bar').style.width = percent + '%';
        document.getElementById('progress-text').innerText = percent + '% gelernt';
    }

    // --- DATEN-IMPORT (PDF AUSZUG) [cite: 6, 7, 8, 13, 14, 16] ---
    // Gebirge
    addPoly(lgGebirge, [[58,6], [62,10], [69,19], [70,25], [60,5]], "Skandinavisches Gebirge", "Gebirge", "#8b4513");
    addPoly(lgGebirge, [[50,58], [60,59], [66,65], [52,60]], "Ural", "Gebirge", "#8b4513");
    addPoly(lgGebirge, [[44,7], [48,16], [46,14]], "Alpen", "Gebirge", "#8b4513");
    addPoly(lgGebirge, [[43,-1.5], [42.5,3]], "PyrenÃ¤en", "Gebirge", "#8b4513");
    addPoly(lgGebirge, [[44,37], [41,49], [42,50]], "Kaukasus", "Gebirge", "#8b4513");
    addPoly(lgGebirge, [[50.5,15], [51,16], [50,17.5]], "Sudeten", "Gebirge", "#8b4513");

    // FlÃ¼sse [cite: 13]
    addLine(lgFluesse, [[62,11.5], [59,10.9]], "Glama");
    addLine(lgFluesse, [[62,12], [59,13.5]], "KlarÃ¤lv");
    addLine(lgFluesse, [[57,33], [53,49], [46,48]], "Wolga");
    addLine(lgFluesse, [[48,8], [47,19], [45,29]], "Donau");
    addLine(lgFluesse, [[46,9], [51,4]], "Rhein");
    addLine(lgFluesse, [[50,15], [53,8]], "Elbe");
    addLine(lgFluesse, [[54,38], [47,39]], "Don");

    // Seen [cite: 14]
    addPoly(lgSeen, [[58,12], [59,14], [58,14]], "VÃ¤nersee", "See", "#3498db");
    addPoly(lgSeen, [[60,30], [61,33], [60,33]], "Ladogasee", "See", "#3498db");
    addPoly(lgSeen, [[61,34], [62,36]], "Onegasee", "See", "#3498db");
    addPoly(lgSeen, [[47.4,9.1], [47.8,9.5]], "Bodensee", "See", "#3498db");

    // Inseln [cite: 16]
    addPoly(lgInseln, [[67.5,12], [69,16]], "Lofoten", "Insel", "#9b59b6");
    addPoly(lgInseln, [[63,-24], [66,-13]], "Island", "Insel", "#9b59b6");
    addPoly(lgInseln, [[36,12], [38,15]], "Sizilien", "Insel", "#9b59b6");
    addPoly(lgInseln, [[44,32], [46,36]], "Krim", "Halbinsel", "#9b59b6");

    // StÃ¤dte
    addCity([52.52, 13.40], "Berlin");
    addCity([48.85, 2.35], "Paris");
    addCity([55.75, 37.61], "Moskau");
    addCity([51.50, -0.12], "London");

    updateUI();
</script>
</body>
</html>
